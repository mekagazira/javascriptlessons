<!DOCTYPE html>
<html lang="jp">
  <head>
    <meta charset="utf-8">
    <title>神経衰弱ゲーム</title>
  </head>
  <style>
    input{
      font-size:18px;
    }
  </style>
  <body>
    <h1>神経衰弱ゲーム</h1>
    <p>
      score:<span id="score"></span>
    </p>

    <input type="button" id="card_0" value="?">
    <input type="button" id="card_1" value="?"><br>
    <input type="button" id="card_2" value="?">
    <input type="button" id="card_3" value="?">

    <!--
    <div id="stage">
    </div>
    -->

    <script>

    (function(){
        var cards = [],
            CARD_NUM = 4,
            currentNum,
            timerId,
            openedCardtimer,
            correntNum = 0,
            enableFlip=true,
            score = 0;

        document.getElementById('card_0').onclick = function(){
          flip(0);
        };

        document.getElementById('card_1').onclick = function(){
          flip(1);
        };

        document.getElementById('card_2').onclick = function(){
          flip(2);
        };

        document.getElementById('card_3').onclick = function(){
          flip(3);
        };


        // function createCard(num){
        //   var card = document.createElement('input');
        //   card.type = 'button';
        //   card.value = '?';
        //   card.dataset.num =num;
        // }

        function flip(n){
          var card = document.getElementById('card_'+n);

          // 既に2枚オープンしている場合
          if(!enableFlip){
            return;
          }

          // open済みのカードを押下した場合
          if(card.value != '?'){
            return;
          }

          card.value = cards[n];
          if( typeof currentNum == 'undefined'){
            // 1枚目
            openedCard = n;
            currentNum = cards[n];
          } else {
            // 2枚目
            // 判定処理
            judge(n);
            currentNum = undefined;
          }
        }

        function judge(n){
          if(currentNum ==  cards[n]){
            // 正解処理
            correntNum++;

            if(correntNum == CARD_NUM / 2){
              clearTimeout(timerId);
              alert("your score is " + document.getElementById('score').innerHTML);
            }
          } else {
            enableFlip=false;
            // 不正解処理
            setTimeout(function(){
              document.getElementById('card_' + openedCard).value = '?';
              document.getElementById('card_' + n).value = '?';
              enableFlip=true;
            },700 )
          }
        }

        function initCards(){
          var num,
              cardIndex,
              i;


          for(i = 0; i < CARD_NUM; i++){
            num = Math.floor(i/2);
            do {
              cardIndex = Math.floor(Math.random() * CARD_NUM);
            } while( typeof cards[cardIndex] !== 'undefined');
            cards[cardIndex] = num;
          }

          var el = document.getElementsByTagName('input');
          for(i=0; i < el.length; i++){
            el[i].onclick = function(){
              flip(this.id.replace(/^card_/,''));
            }
          }
        }

        function runTimer(){
          document.getElementById('score').innerHTML = score++;
          timerId = setTimeout(function(){
            runTimer();
          },100)
        }

        initCards();
        runTimer();

    })();
    </script>

  </body>
</html>
